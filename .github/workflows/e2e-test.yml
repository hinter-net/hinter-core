name: End-to-End Test

on:
  workflow_dispatch:

jobs:
  hinter1:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies and build package
        run: |
          npm install
          npm run build:package

      - name: Install package globally and pm2
        run: |
          npm install -g hinter-net-hinter-core-*.tgz
          npm install -g pm2

      - name: Setup hinter1
        run: |
          mkdir -p hinter-core-data/peers/hinter2/outgoing
          mkdir -p hinter-core-data/peers/hinter2/incoming
          echo "{\"publicKey\":\"9e230ac8b403f3861871c2325f3226c930e7e4f0809b6633a6870aa05904ef01\"}" > hinter-core-data/peers/hinter2/hinter.config.json
          echo "PUBLIC_KEY=1720090ca74ba7c5100c5c9bf7898171fbae0ede675fa7c3aa248bd1d6c96a8f" > hinter-core-data/.env
          echo "SECRET_KEY=a580f4d154155ff2947855b7770435015c111bb5e1ae31b0915bded7d9b1ecbb1720090ca74ba7c5100c5c9bf7898171fbae0ede675fa7c3aa248bd1d6c96a8f" >> hinter-core-data/.env

      - name: Run hinter-core in background
        run: pm2 start hinter-core --name hinter1 -- --data-dir $(pwd)/hinter-core-data

      - name: Wait for instance to be ready
        run: sleep 10

      - name: Create report
        run: |
          echo "Creating report file..."
          echo "hello from hinter1" > ./hinter-core-data/peers/hinter2/outgoing/report-from-1.txt
          echo "Report file created"

      - name: Wait for sync and verify
        run: |
          echo "Waiting for report from hinter2..."
          timeout=180
          interval=5
          elapsed=0
          FILE_PATH="./hinter-core-data/peers/hinter2/incoming/report-from-2.txt"
          EXPECTED_CONTENT="hello from hinter2"
          while ! ( [ -f "$FILE_PATH" ] && grep -q "$EXPECTED_CONTENT" "$FILE_PATH" ); do
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout reached. Report with expected content not found."
              pm2 logs hinter1 --lines 200 --nostream
              exit 1
            fi
            sleep $interval
            elapsed=$((elapsed + interval))
            echo "Still waiting..."
          done
          echo "Report with correct content received!"
          pm2 logs hinter1 --lines 200 --nostream
          cat "$FILE_PATH"

      - name: Keep container alive for other job
        run: sleep 180

  hinter2:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies and build package
        run: |
          npm install
          npm run build:package

      - name: Install package globally and pm2
        run: |
          npm install -g hinter-net-hinter-core-*.tgz
          npm install -g pm2

      - name: Setup hinter2
        run: |
          mkdir -p hinter-core-data/peers/hinter1/outgoing
          mkdir -p hinter-core-data/peers/hinter1/incoming
          echo "{\"publicKey\":\"1720090ca74ba7c5100c5c9bf7898171fbae0ede675fa7c3aa248bd1d6c96a8f\"}" > hinter-core-data/peers/hinter1/hinter.config.json
          echo "PUBLIC_KEY=9e230ac8b403f3861871c2325f3226c930e7e4f0809b6633a6870aa05904ef01" > hinter-core-data/.env
          echo "SECRET_KEY=0646dadeeaf79af9aab9954d7c63a52fa2ee1e1c04276cc0b760c6dd5c920d899e230ac8b403f3861871c2325f3226c930e7e4f0809b6633a6870aa05904ef01" >> hinter-core-data/.env

      - name: Run hinter-core in background
        run: pm2 start hinter-core --name hinter2 -- --data-dir $(pwd)/hinter-core-data

      - name: Wait for instance to be ready
        run: sleep 10

      - name: Create report
        run: |
          echo "Creating report file..."
          echo "hello from hinter2" > ./hinter-core-data/peers/hinter1/outgoing/report-from-2.txt
          echo "Report file created"

      - name: Wait for sync and verify
        run: |
          echo "Waiting for report from hinter1..."
          timeout=180
          interval=5
          elapsed=0
          FILE_PATH="./hinter-core-data/peers/hinter1/incoming/report-from-1.txt"
          EXPECTED_CONTENT="hello from hinter1"
          while ! ( [ -f "$FILE_PATH" ] && grep -q "$EXPECTED_CONTENT" "$FILE_PATH" ); do
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout reached. Report with expected content not found."
              pm2 logs hinter2 --lines 200 --nostream
              exit 1
            fi
            sleep $interval
            elapsed=$((elapsed + interval))
            echo "Still waiting..."
          done
          echo "Report with correct content received!"
          pm2 logs hinter2 --lines 200 --nostream
          cat "$FILE_PATH"

      - name: Keep container alive for other job
        run: sleep 180
